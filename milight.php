<?php

	// Milight V6 Lamp Settings
	$server = '192.168.0.19';
	$port 	= 5987;

	// Create Socket
	$socket = socket_create( AF_INET, SOCK_DGRAM, SOL_UDP );

	// Session Hex Command
	$session = array(0x20, 0x00, 0x00, 0x00, 0x16, 0x02, 0x62, 0x3A, 0xD5,
			 0xED, 0xA3, 0x01, 0xAE, 0x08, 0x2D, 0x46, 0x61, 0x41,
			 0xA7, 0xF6, 0xDC, 0xAF, 0xD3, 0xE6, 0x00, 0x00, 0x1E);

	// Convert to Bytes
	$msg = vsprintf( str_repeat( '%c', count( $session ) ), $session );

	// Request Session Numbers
	socket_sendto( $socket, $msg, strlen( $msg ), 0, $server, $port );

	if( $response = socket_read( $socket, 22 ) ) {
	
		// Retrieve Session Numbers
		$bytes 	= str_split( bin2hex( $response ), 2 );
		$wb1 	= $bytes[ count( $bytes ) - 3 ]; // Wifi Bridge Session ID1
		$wb2 	= $bytes[ count( $bytes ) - 2 ]; // Wifi Bridge Session ID2
	   
		
		// Command segments
			$prefix 			= array( 0x80, 0x00, 0x00, 0x00, 0x11 );
		
			// General
			$on 				= array( 0x31, 0x00, 0x00, 0x08, 0x04, 0x01, 0x00, 0x00, 0x00 );
			$off 				= array( 0x31, 0x00, 0x00, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00 );
			$nightlight 			= array( 0x31, 0x00, 0x00, 0x08, 0x04, 0x05, 0x00, 0x00, 0x00 );
		
			// Colours
			$blue 				= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0xBA, 0xBA, 0xBA, 0xBA );
			$lightblue 			= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0x7A, 0x7A, 0x7A, 0x7A );
			$red 				= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0x0A, 0x0A, 0x0A, 0x0A );
			$orange 			= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0x1E, 0x1E, 0x1E, 0x1E );
			$yellow 			= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0x2F, 0x2F, 0x2F, 0x2F );
			$pink 				= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0xFF, 0xFF, 0xFF, 0xFF );
			$limegreen 			= array( 0x31, 0x00, 0x00, 0x08, 0x01, 0x4A, 0x4A, 0x4A, 0x4A );

			// Saturation ( 0% - 100% )
			$sat0				= array( 0x31, 0x00, 0x00, 0x08, 0x02, 0x64, 0x00, 0x00, 0x00 );
			$sat25				= array( 0x31, 0x00, 0x00, 0x08, 0x02, 0x4B, 0x00, 0x00, 0x00 );
			$sat50				= array( 0x31, 0x00, 0x00, 0x08, 0x02, 0x32, 0x00, 0x00, 0x00 );
			$sat75				= array( 0x31, 0x00, 0x00, 0x08, 0x02, 0x19, 0x00, 0x00, 0x00 );
			$sat100				= array( 0x31, 0x00, 0x00, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00 );

			// Brightness ( 0% - 100% )
			$bright0			= array( 0x31, 0x00, 0x00, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00 );
			$bright25			= array( 0x31, 0x00, 0x00, 0x08, 0x03, 0x19, 0x00, 0x00, 0x00 );
			$bright50			= array( 0x31, 0x00, 0x00, 0x08, 0x03, 0x32, 0x00, 0x00, 0x00 );
			$bright75			= array( 0x31, 0x00, 0x00, 0x08, 0x03, 0x4B, 0x00, 0x00, 0x00 );
			$bright100			= array( 0x31, 0x00, 0x00, 0x08, 0x03, 0x64, 0x00, 0x00, 0x00 );
		
		// Selected Command
		$command = (isset($_GET['cmd'])) ? ${$_GET['cmd']} : $on;
		
		// Zone
		$zone = (isset($_GET['zone'])) ? $_GET['zone'] : 0;
		
		// Calculate Checksum
		$checksumSegments = array_merge( $command, array( $zone, 00 ) );
		$checksum = 0;
		for ( $i = 0; $i < count( $checksumSegments ); $i++ ) {
			$checksum += $checksumSegments[ $i ];
		}
		$checksum = dechex( $checksum );
		
		// Correct invalid checksum ( ie. use only last two digits )
		if(strlen($checksum) > 2) {
			$checksum = substr($checksum, strlen($checksum) - 2, 2);
		}
	   
		// Convert command segments to string
		function hexString( $data ) {
		
			$string = "";
			for ( $i = 0; $i < count( $data ); $i++ ) {
				
				$string .= sprintf("%02X", $data[ $i ]);
				
			}
		   
			return $string;
		   
		}
		$prefix = hexString( $prefix );
		$command = hexString( $command );
	   
	/*
		Construct Message
		
		$msg = hex2bin($prefix . $wb1 . $wb2 . "00" . $seqNum . "00" . $command .    $zone    . "00" . $checksum);
	*/
		
		$msg = hex2bin($prefix . $wb1 . $wb2 . "00" .   "01"  . "00" . $command . "0" . $zone . "00" . $checksum);
			
		// Send Command
		socket_sendto( $socket, $msg, strlen( $msg ), 0, $server, $port );

		// Output Response
		if( $response = socket_read( $socket, 8 ) ) {
			echo chunk_split( bin2hex( $response ), 2, " " );
		}

	} 

?>
